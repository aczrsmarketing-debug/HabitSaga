<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#03110D" />
  <meta name="description" content="Saga de Hábitos · RPG Habit Tracker" />
  <title>SAGA DE HÁBITOS</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="apple-mobile-web-app-title" content="HabitSaga" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Roboto+Mono:wght@400;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg-0: #03110d;
      --bg-1: #16302b;
      --bg-2: #0c324a;
      --bg-3: #390517;
      --accent: #c11720;
      --accent-glow: rgba(193, 23, 32, 0.35);
      --gold: #fef1d5;
      --gray: #e0e0e0;
      --chart-blue: #679cbc;
      --chart-brown: #a38560;
      --rank-e: #9e9e9e;
      --rank-d: #66bb6a;
      --rank-c: #42a5f5;
      --rank-b: #ab47bc;
      --rank-a: #ffa726;
      --rank-s: #ffd700;
      --hp-green: #2ecc71;
      --hp-yellow: #f39c12;
      --hp-red: #c11720;
      --border: rgba(254, 241, 213, 0.12);
      --border-bright: rgba(254, 241, 213, 0.3);
      --header-h: 62px;
      --nav-h: 68px;
      --radius: 4px;
      --radius-lg: 8px;
      --font: "Roboto", sans-serif;
      --mono: "Roboto Mono", monospace;
      --transition: 0.18s ease;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--bg-0);
      font-family: var(--font);
      color: var(--gray);
      -webkit-font-smoothing: antialiased;
      user-select: none;
      -webkit-user-select: none;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    img {
      display: block;
      max-width: 100%;
    }

    input,
    textarea,
    select {
      font-family: var(--font);
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border-bright);
      color: var(--gold);
      border-radius: var(--radius);
      outline: none;
      font-size: 14px;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
    }

    button {
      cursor: pointer;
      border: none;
      font-family: var(--font);
    }

    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-bright);
      border-radius: 2px;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.03) 2px,
        rgba(0, 0, 0, 0.03) 4px
      );
      pointer-events: none;
      z-index: 9999;
    }

    #app {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg-0);
    }

    header {
      height: var(--header-h);
      min-height: var(--header-h);
      background: linear-gradient(135deg, rgba(12, 50, 74, 0.95) 0, rgba(3, 17, 13, 0.98) 100%);
      border-bottom: 1px solid var(--border-bright);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
      position: relative;
      z-index: 100;
    }

    header::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .header-logo {
      font-size: 11px;
      font-weight: 900;
      letter-spacing: 3px;
      color: var(--gold);
      text-transform: uppercase;
      flex: 1;
    }

    .header-logo span {
      color: var(--accent);
    }

    .header-rank-badge {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: 1px;
      border: 2px solid currentColor;
      border-radius: var(--radius);
      position: relative;
      transition: var(--transition);
    }

    .header-level {
      font-size: 11px;
      font-weight: 700;
      color: var(--gold);
      text-align: right;
      line-height: 1.3;
    }

    .header-level .lv {
      font-size: 9px;
      color: var(--gray);
      letter-spacing: 1px;
    }

    #screens {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .screen {
      position: absolute;
      inset: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding-bottom: 8px;
      display: none;
    }

    .screen.active {
      display: block;
    }

    .panel {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 14px;
      position: relative;
      overflow: hidden;
    }

    .panel-title {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--chart-brown);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title::after {
      content: "";
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .stat-bar {
      width: 100%;
      height: 6px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      overflow: hidden;
    }

    .stat-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .bar-hp .stat-bar-fill {
      background: var(--hp-red);
    }

    .bar-xp .stat-bar-fill {
      background: linear-gradient(90deg, var(--chart-blue), #a0d8ef);
    }

    .stat-bar-lg {
      height: 10px;
      border-radius: 5px;
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      font-size: 13px;
      font-weight: 900;
      border: 2px solid currentColor;
      border-radius: 3px;
    }

    .rank-E {
      color: var(--rank-e);
    }

    .section-header {
      padding: 16px 16px 8px;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--chart-brown);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-header::after {
      content: "";
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .toast {
      position: fixed;
      top: calc(var(--header-h) + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22, 48, 43, 0.97);
      border: 1px solid var(--border-bright);
      color: var(--gold);
      font-size: 12px;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: var(--radius);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
      max-width: 300px;
      text-align: center;
      white-space: nowrap;
      border-top: 2px solid var(--accent);
    }

    .toast.show {
      opacity: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .stat-kpi {
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 12px 10px;
      text-align: center;
    }

    .stat-kpi-val {
      font-size: 22px;
      font-weight: 900;
      font-family: var(--mono);
      color: var(--gold);
      line-height: 1;
    }

    .stat-kpi-label {
      font-size: 9px;
      letter-spacing: 1px;
      color: var(--gray);
      opacity: 0.6;
      margin-top: 4px;
      text-transform: uppercase;
    }

    .chart-wrap {
      position: relative;
      height: 180px;
    }

    .chart-wrap-sm {
      position: relative;
      height: 130px;
    }

    .chart-wrap canvas,
    .chart-wrap-sm canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .progress-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .progress-item .progress-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .progress-name {
      font-size: 12px;
      color: var(--gray);
    }

    .progress-pct {
      font-size: 11px;
      font-family: var(--mono);
      color: var(--chart-blue);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--chart-brown), #c4a882);
    }

    .arena-header {
      background: linear-gradient(135deg, rgba(57, 5, 23, 0.8), rgba(3, 17, 13, 0.9));
      border: 1px solid rgba(193, 23, 32, 0.3);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 12px;
      text-align: center;
    }

    .arena-title {
      font-size: 14px;
      font-weight: 900;
      letter-spacing: 4px;
      color: var(--gold);
      text-transform: uppercase;
    }

    .arena-sub {
      font-size: 10px;
      color: var(--gray);
      opacity: 0.6;
      margin-top: 4px;
    }

    .leaderboard .lb-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      margin-bottom: 6px;
      background: var(--bg-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: var(--transition);
    }

    .leaderboard .lb-row.me {
      border-color: rgba(193, 23, 32, 0.4);
      background: rgba(57, 5, 23, 0.4);
    }

    .lb-pos {
      font-size: 14px;
      font-weight: 900;
      font-family: var(--mono);
      color: var(--gray);
      width: 24px;
    }

    .lb-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--bg-3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .lb-info {
      flex: 1;
    }

    .lb-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--gold);
    }

    .lb-sub {
      font-size: 10px;
      color: var(--gray);
      opacity: 0.6;
      margin-top: 1px;
    }

    .lb-xp {
      font-size: 13px;
      font-weight: 700;
      font-family: var(--mono);
      color: var(--chart-blue);
    }

    .invite-card {
      background: var(--bg-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 12px;
    }

    .invite-link-box {
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      margin: 10px 0;
    }

    .invite-link-text {
      flex: 1;
      font-size: 11px;
      font-family: var(--mono);
      color: var(--chart-blue);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .copy-btn {
      font-size: 11px;
      font-weight: 700;
      color: var(--gold);
      background: transparent;
      padding: 4px 8px;
      border: 1px solid var(--border-bright);
      border-radius: 3px;
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .sync-dot.live {
      background: #2ecc71;
      animation: pulse 2s infinite;
    }

    .sync-dot.idle {
      background: var(--gray);
      opacity: 0.4;
    }

    @keyframes pulse {
      0%,
      100% {
        opacity: 1;
      }
      50% {
        opacity: 0.4;
      }
    }

    #bottom-nav {
      height: var(--nav-h);
      min-height: var(--nav-h);
      background: rgba(3, 17, 13, 0.97);
      border-top: 1px solid var(--border-bright);
      display: flex;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      background: transparent;
      color: rgba(224, 224, 224, 0.45);
      padding: 8px 4px;
      transition: var(--transition);
      position: relative;
    }

    .nav-btn.active {
      color: var(--gold);
    }

    .nav-btn.active::after {
      content: "";
      position: absolute;
      top: 0;
      left: 20%;
      right: 20%;
      height: 2px;
      background: var(--accent);
      border-radius: 0 0 2px 2px;
    }

    .nav-btn svg {
      width: 22px;
      height: 22px;
    }

    .nav-label {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }
  </style>
</head>

<body>
  <!-- Setup inicial (nombre, clase, modo gratuito) -->
  <!-- … puedes conservar tu bloque setup original aquí si no lo habías modificado … -->

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- APP -->
  <div id="app" style="display: none;">
    <!-- Header -->
    <header id="header">
      <div class="header-logo">
        SAGA DE <span>HÁBITOS</span>
      </div>
      <div id="header-rank" class="header-rank-badge rank-E">E</div>
      <div class="header-level">
        <div class="lv">NIVEL</div>
        <div id="header-level-num" style="font-size:16px;font-weight:900;color:var(--gold);font-family:var(--mono)">1</div>
      </div>
    </header>

    <!-- Screens -->
    <main id="screens">
      <!-- HOME -->
      <!-- (mantén aquí todo tu HTML de la pantalla home tal como lo tenías, no se toca para este fix) -->

      <!-- STATS -->
      <div id="screen-stats" class="screen">
        <div style="padding:12px 12px 0;">
          <div class="stats-grid" id="kpi-grid">
            <div class="stat-kpi">
              <div class="stat-kpi-val" id="kpi-xp">0</div>
              <div class="stat-kpi-label">XP Total</div>
            </div>
            <div class="stat-kpi">
              <div class="stat-kpi-val" id="kpi-tasks">0</div>
              <div class="stat-kpi-label">Tareas</div>
            </div>
            <div class="stat-kpi">
              <div class="stat-kpi-val" id="kpi-streak">0</div>
              <div class="stat-kpi-label">Racha</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-title">Distribución de Stats</div>
            <div class="chart-wrap">
              <canvas id="radar-chart"></canvas>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-title">Racha últimos 30 días</div>
            <div class="chart-wrap">
              <canvas id="xp-chart"></canvas>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-title">Progreso por STAT</div>
            <div class="chart-wrap-sm">
              <canvas id="bar-chart"></canvas>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-title">Progreso por Área</div>
            <div class="progress-list" id="progress-list"></div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <!-- (mantén tu pantalla de perfil igual que en tu archivo original) -->

      <!-- ARENA -->
      <div id="screen-arena" class="screen">
        <div style="padding:12px 12px 0;">
          <div class="arena-header">
            <div class="arena-title">ARENA</div>
            <div class="arena-sub">Compite · Invita · Supera</div>
            <div style="margin-top:8px;font-size:11px;color:var(--gray);">
              <span id="sync-dot" class="sync-dot idle"></span>
              <span id="sync-status">Sin sincronización</span>
            </div>
          </div>

          <div class="invite-card">
            <div class="panel-title">Invitar Amigos</div>
            <p style="font-size:12px;color:var(--gray);margin-bottom:10px;">
              Comparte tu perfil para competir en el leaderboard familiar.
            </p>
            <div class="invite-link-box">
              <span id="invite-link" class="invite-link-text">Genera un link de invitación...</span>
              <button class="copy-btn" onclick="copyInvite()">COPIAR</button>
            </div>
            <button class="btn btn-primary" onclick="generateInvite()" style="width:100%;margin-top:8px;">
              GENERAR LINK
            </button>
          </div>

          <div class="section-header">Clasificación</div>
          <div id="leaderboard" class="leaderboard"></div>

          <div class="section-header">Unirse a Grupo</div>
          <div class="panel" style="margin-bottom:12px;">
            <div style="font-size:12px;color:var(--gray);margin-bottom:10px;">
              Ingresa el ID de grupo de un amigo
            </div>
            <div style="display:flex;gap:8px;">
              <input type="text" id="join-code" class="input-field" style="flex:1;padding:10px 12px;" placeholder="ID de grupo" />
              <button class="btn btn-primary" onclick="joinGroup()">UNIRSE</button>
            </div>
          </div>
          <div style="height:20px;"></div>
        </div>
      </div>
    </main>

    <!-- Bottom nav -->
    <nav id="bottom-nav">
      <button id="nav-home" class="nav-btn active" onclick="navigate('home')">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" /></svg>
        <span class="nav-label">Inicio</span>
      </button>
      <button id="nav-missions" class="nav-btn" onclick="navigate('missions')">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01z" /></svg>
        <span class="nav-label">Misión</span>
      </button>
      <button id="nav-stats" class="nav-btn" onclick="navigate('stats')">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 9.2h3V19H5zM10.6 5h3v14h-3zM16.2 11h3v8h-3z" /></svg>
        <span class="nav-label">Stats</span>
      </button>
      <button id="nav-profile" class="nav-btn" onclick="navigate('profile')">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" /></svg>
        <span class="nav-label">Perfil</span>
      </button>
      <button id="nav-arena" class="nav-btn" onclick="navigate('arena')">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 5v14l7-7z" /></svg>
        <span class="nav-label">Arena</span>
      </button>
    </nav>
  </div>

  <script>
    // URL del Google Apps Script (actualizada)
    const GAS_API_URL =
      "https://script.google.com/macros/s/AKfycbyZmZpF4woW5nwbN2wbrIDfNPGgmr7pK_NdW5zLSQQlR3c01tJIkxwTJNTSRWKtA4vHfQ/exec";

    // ---- Estado mínimo necesario (ajusta a tu objeto state real) ----
    const state = {
      character: {
        name: "Cazador",
      },
      stats: {
        xpTotal: 0,
        tasksCompleted: 0,
        streakDays: 0,
        byStat: {
          vitalidad: 0,
          fuerza: 0,
          agilidad: 0,
          resistencia: 0,
          inteligencia: 0,
          sabiduria: 0,
        },
        streakHistory: [], // 30 días
      },
      multiplayer: {
        roomId: "",
        playerId: "",
        token: "",
      },
    };

    // ---- Utilidades UI ----
    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => t.classList.remove("show"), 2500);
    }

    function navigate(screen) {
      const map = {
        home: "screen-home",
        missions: "screen-missions",
        stats: "screen-stats",
        profile: "screen-profile",
        arena: "screen-arena",
      };
      document.querySelectorAll(".screen").forEach((s) => s.classList.remove("active"));
      const id = map[screen] || "screen-home";
      const el = document.getElementById(id);
      if (el) el.classList.add("active");
      document.querySelectorAll("#bottom-nav .nav-btn").forEach((b) => b.classList.remove("active"));
      const nav = document.getElementById("nav-" + screen);
      if (nav) nav.classList.add("active");

      if (screen === "stats") refreshChartsSoon();
      if (screen === "arena" && state.multiplayer.roomId) {
        refreshLeaderboard();
      }
    }

    // ---- Charts canvas custom (sin Chart.js) ----
    function clearCanvas(ctx) {
      const { width, height } = ctx.canvas;
      ctx.clearRect(0, 0, width, height);
      ctx.setTransform(1, 0, 0, 1, 0, 0);
    }

    function initRadarChart() {
      const canvas = document.getElementById("radar-chart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const W = (canvas.width = canvas.offsetWidth || 300);
      const H = (canvas.height = canvas.offsetHeight || 180);
      clearCanvas(ctx);

      const stats = state.stats.byStat;
      const labels = ["Vitalidad", "Fuerza", "Agilidad", "Resistencia", "Inteligencia", "Sabiduría"];
      const vals = [
        stats.vitalidad || 0,
        stats.fuerza || 0,
        stats.agilidad || 0,
        stats.resistencia || 0,
        stats.inteligencia || 0,
        stats.sabiduria || 0,
      ];
      const maxVal = Math.max(10, ...vals);
      const cx = W / 2;
      const cy = H / 2 + 10;
      const radius = Math.min(W, H) * 0.32;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.strokeStyle = "rgba(254,241,213,0.18)";
      ctx.lineWidth = 1;

      const levels = 4;
      for (let l = 1; l <= levels; l++) {
        const r = (radius * l) / levels;
        ctx.beginPath();
        for (let i = 0; i < labels.length; i++) {
          const ang = (Math.PI * 2 * i) / labels.length - Math.PI / 2;
          const x = Math.cos(ang) * r;
          const y = Math.sin(ang) * r;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.stroke();
      }

      ctx.strokeStyle = "rgba(254,241,213,0.15)";
      for (let i = 0; i < labels.length; i++) {
        const ang = (Math.PI * 2 * i) / labels.length - Math.PI / 2;
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(Math.cos(ang) * radius, Math.sin(ang) * radius);
        ctx.stroke();
      }

      ctx.fillStyle = "rgba(163,133,96,0.35)";
      ctx.strokeStyle = "rgba(163,133,96,0.9)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i < labels.length; i++) {
        const val = vals[i];
        const r = (radius * val) / maxVal;
        const ang = (Math.PI * 2 * i) / labels.length - Math.PI / 2;
        const x = Math.cos(ang) * r;
        const y = Math.sin(ang) * r;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = "rgba(254,241,213,0.85)";
      ctx.font = "10px " + getComputedStyle(document.body).fontFamily;
      for (let i = 0; i < labels.length; i++) {
        const ang = (Math.PI * 2 * i) / labels.length - Math.PI / 2;
        const x = Math.cos(ang) * (radius + 10);
        const y = Math.sin(ang) * (radius + 10);
        ctx.textAlign = x < 0 ? "right" : x > 0 ? "left" : "center";
        ctx.textBaseline = y > 5 ? "top" : y < -5 ? "bottom" : "middle";
        ctx.fillText(labels[i], x, y);
      }

      ctx.restore();
    }

    function initXpChart() {
      const canvas = document.getElementById("xp-chart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const W = (canvas.width = canvas.offsetWidth || 300);
      const H = (canvas.height = canvas.offsetHeight || 180);
      clearCanvas(ctx);

      const history = state.stats.streakHistory || [];
      const n = 30;
      const data = [];
      for (let i = 0; i < n; i++) {
        data.push(history[i] || 0);
      }

      const maxVal = Math.max(1, ...data);
      const padL = 20;
      const padR = 6;
      const padT = 8;
      const padB = 18;
      const innerW = W - padL - padR;
      const innerH = H - padT - padB;

      ctx.save();
      ctx.translate(padL, padT);

      ctx.strokeStyle = "rgba(254,241,213,0.12)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, innerH);
      ctx.lineTo(innerW, innerH);
      ctx.stroke();

      ctx.beginPath();
      let started = false;
      for (let i = 0; i < n; i++) {
        const x = (innerW * i) / (n - 1);
        const v = data[i];
        const y = innerH - (innerH * v) / maxVal;
        if (!started) {
          ctx.moveTo(x, y);
          started = true;
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.strokeStyle = "rgba(103,156,188,0.9)";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.beginPath();
      for (let i = 0; i < n; i++) {
        const x = (innerW * i) / (n - 1);
        const v = data[i];
        const y = innerH - (innerH * v) / maxVal;
        if (i === 0) ctx.moveTo(x, innerH);
        ctx.lineTo(x, y);
      }
      ctx.lineTo(innerW, innerH);
      ctx.closePath();
      const grad = ctx.createLinearGradient(0, padT, 0, innerH);
      grad.addColorStop(0, "rgba(103,156,188,0.35)");
      grad.addColorStop(1, "rgba(103,156,188,0)");
      ctx.fillStyle = grad;
      ctx.fill();

      ctx.restore();
    }

    function initBarChart() {
      const canvas = document.getElementById("bar-chart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const W = (canvas.width = canvas.offsetWidth || 300);
      const H = (canvas.height = canvas.offsetHeight || 130);
      clearCanvas(ctx);

      const stats = state.stats.byStat;
      const labels = ["Vit", "Fza", "Agi", "Res", "Int", "Sab"];
      const vals = [
        stats.vitalidad || 0,
        stats.fuerza || 0,
        stats.agilidad || 0,
        stats.resistencia || 0,
        stats.inteligencia || 0,
        stats.sabiduria || 0,
      ];
      const maxVal = Math.max(1, ...vals);
      const padL = 24;
      const padR = 6;
      const padT = 10;
      const padB = 18;
      const innerW = W - padL - padR;
      const innerH = H - padT - padB;

      ctx.save();
      ctx.translate(padL, padT);

      const barWidth = innerW / (labels.length * 1.6);
      const gap = barWidth * 0.6;

      ctx.fillStyle = "rgba(254,241,213,0.10)";
      ctx.fillRect(0, innerH, innerW, 1);

      for (let i = 0; i < labels.length; i++) {
        const v = vals[i];
        const h = (innerH * v) / maxVal;
        const x = i * (barWidth + gap);
        const y = innerH - h;
        const grad = ctx.createLinearGradient(0, y, 0, innerH);
        grad.addColorStop(0, "rgba(163,133,96,0.95)");
        grad.addColorStop(1, "rgba(163,133,96,0.35)");
        ctx.fillStyle = grad;
        ctx.fillRect(x, y, barWidth, h);

        ctx.fillStyle = "rgba(254,241,213,0.85)";
        ctx.font = "9px " + getComputedStyle(document.body).fontFamily;
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        ctx.fillText(labels[i], x + barWidth / 2, innerH + 3);
      }

      ctx.restore();
    }

    let chartsTimeout;
    function refreshChartsSoon() {
      clearTimeout(chartsTimeout);
      chartsTimeout = setTimeout(() => {
        initRadarChart();
        initXpChart();
        initBarChart();
        renderProgressList();
      }, 60);
    }

    function renderProgressList() {
      const el = document.getElementById("progress-list");
      if (!el) return;
      const s = state.stats.byStat;
      const total =
        (s.vitalidad || 0) +
        (s.fuerza || 0) +
        (s.agilidad || 0) +
        (s.resistencia || 0) +
        (s.inteligencia || 0) +
        (s.sabiduria || 0) || 1;

      const entries = [
        ["Vitalidad", s.vitalidad || 0],
        ["Fuerza", s.fuerza || 0],
        ["Agilidad", s.agilidad || 0],
        ["Resistencia", s.resistencia || 0],
        ["Inteligencia", s.inteligencia || 0],
        ["Sabiduría", s.sabiduria || 0],
      ];

      el.innerHTML = "";
      for (const [name, val] of entries) {
        const pct = Math.round((val * 100) / total);
        const row = document.createElement("div");
        row.className = "progress-item";
        row.innerHTML = `
          <div class="progress-row">
            <div class="progress-name">${name}</div>
            <div class="progress-pct">${pct}%</div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${pct}%;"></div>
          </div>
        `;
        el.appendChild(row);
      }
    }

    // ---- GAS JSONP helper ----
    async function apiGetJSONP(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cbName = "gas_cb_" + Math.random().toString(36).slice(2);
        params.action = action;
        params.callback = cbName;

        const url = GAS_API_URL + "?" + new URLSearchParams(params).toString();

        window[cbName] = (data) => {
          delete window[cbName];
          script.remove();
          resolve(data);
        };

        const script = document.createElement("script");
        script.src = url;
        script.onerror = () => {
          delete window[cbName];
          script.remove();
          reject(new Error("Error cargando JSONP (GAS)."));
        };
        document.body.appendChild(script);
      });
    }

    // ---- Arena ----
    async function generateInvite() {
      try {
        const res = await apiGetJSONP("createRoom", {
          name: state.character.name || "Cazador",
        });
        if (res.error) throw new Error(res.error);

        state.multiplayer.roomId = res.roomId;
        document.getElementById("invite-link").textContent =
          location.origin + location.pathname + "?room=" + res.roomId;
        document.getElementById("sync-status").textContent = "Sala creada";
        document.getElementById("sync-dot").classList.remove("idle");
        document.getElementById("sync-dot").classList.add("live");

        showToast("Sala creada: " + res.roomId);
      } catch (e) {
        showToast("No pude crear sala: " + e.message);
      }
    }

    function copyInvite() {
      const txt = document.getElementById("invite-link").textContent || "";
      if (!txt || txt.includes("Genera un link")) {
        showToast("Primero genera el link.");
        return;
      }
      navigator.clipboard
        .writeText(txt)
        .then(() => showToast("Link copiado."))
        .catch(() => showToast("No pude copiar el link."));
    }

    async function joinGroup() {
      const code = document.getElementById("join-code").value.trim();
      if (!code) {
        showToast("Ingresa un ID de grupo.");
        return;
      }
      try {
        const res = await apiGetJSONP("joinRoom", {
          roomId: code,
          displayName: state.character.name || "Cazador",
        });
        if (res.error) throw new Error(res.error);
        state.multiplayer.roomId = res.roomId;
        state.multiplayer.playerId = res.playerId;
        state.multiplayer.token = res.token;
        document.getElementById("sync-status").textContent = "Conectado a sala";
        document.getElementById("sync-dot").classList.remove("idle");
        document.getElementById("sync-dot").classList.add("live");
        showToast("Te uniste a la sala.");
        refreshLeaderboard();
      } catch (e) {
        showToast("No pude unirme: " + e.message);
      }
    }

    async function refreshLeaderboard() {
      if (!state.multiplayer.roomId) return;
      try {
        const res = await apiGetJSONP("getLeaderboard", {
          roomId: state.multiplayer.roomId,
        });
        if (res.error) throw new Error(res.error);
        const lb = res.leaderboard || [];
        const box = document.getElementById("leaderboard");
        box.innerHTML = "";
        lb.forEach((p, i) => {
          const row = document.createElement("div");
          row.className = "lb-row" + (p.playerId === state.multiplayer.playerId ? " me" : "");
          row.innerHTML = `
            <div class="lb-pos">${i + 1}</div>
            <div class="lb-avatar">⚔</div>
            <div class="lb-info">
              <div class="lb-name">${p.displayName || "Jugador"}</div>
              <div class="lb-sub">Racha ${p.streakDays} · Misiones ${p.missionsCompleted}</div>
            </div>
            <div class="lb-xp">${p.xp} XP</div>
          `;
          box.appendChild(row);
        });
      } catch (e) {
        showToast("No pude actualizar ranking: " + e.message);
      }
    }

    // ---- Init mínimo ----
    window.addEventListener("load", () => {
      document.getElementById("app").style.display = "flex";
      navigate("home");
    });
  </script>
</body>
</html>
