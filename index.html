<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>OPERADOR</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%;background:#0B0F12}
body{min-height:100%;background:#0B0F12;color:#E6EDF3;font-family:'Rajdhani',sans-serif;font-size:16px;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;overscroll-behavior:none}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:#0B0F12}
::-webkit-scrollbar-thumb{background:#2A3036;border-radius:2px}

#app{max-width:480px;margin:0 auto;min-height:100vh;position:relative;padding-bottom:58px}

/* HUD */
#hud{background:#1A1F24;border-bottom:1px solid #2A3036;padding:10px 16px;position:sticky;top:0;z-index:100}
.hud-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.hud-avatar{background:#2A3036;border:1px solid #6CFF3D;width:38px;height:38px;display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace;font-size:14px;color:#6CFF3D;flex-shrink:0}
.hud-info{margin-left:10px;flex:1}
.hud-name{font-weight:700;font-size:15px;letter-spacing:2px;text-transform:uppercase}
.hud-sub{font-family:'Share Tech Mono',monospace;font-size:10px;color:#9BA3AB;letter-spacing:2px}
.hud-right{display:flex;gap:14px;align-items:center}
.hud-stat{text-align:right}
.hs-lbl{font-family:'Share Tech Mono',monospace;font-size:9px;color:#9BA3AB;letter-spacing:2px;display:block;text-transform:uppercase}
.hs-val{font-family:'Share Tech Mono',monospace;font-size:15px;line-height:1.2}
.hud-bars{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.bar-row{display:flex;justify-content:space-between;margin-bottom:3px}
.blbl{font-family:'Share Tech Mono',monospace;font-size:9px;color:#9BA3AB;letter-spacing:2px;text-transform:uppercase}
.btrack{height:4px;background:#2A3036;border-radius:1px;overflow:hidden}
.bfill{height:100%;border-radius:1px;transition:width .6s ease}

/* NAV */
#nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:#1A1F24;border-top:1px solid #2A3036;display:grid;grid-template-columns:repeat(4,1fr);padding:0 8px;z-index:100}
.nav-btn{background:transparent;border:none;font-family:'Rajdhani',sans-serif;font-weight:600;font-size:12px;letter-spacing:1.5px;text-transform:uppercase;color:#9BA3AB;padding:12px 0 10px;cursor:pointer;position:relative;transition:color .15s}
.nav-btn.active{color:#6CFF3D}
.nav-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:#6CFF3D}

/* PANELS */
.panel{background:#1A1F24;border:1px solid #2A3036;padding:16px;margin-bottom:12px}
.slbl{font-family:'Share Tech Mono',monospace;font-size:9px;color:#9BA3AB;letter-spacing:2px;text-transform:uppercase;display:block;margin-bottom:10px}
.tab-pane{padding:16px;animation:fadein .18s ease}

/* TAGS */
.tag{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;padding:2px 7px;border-radius:2px}
.tg-e{background:rgba(154,154,154,.12);color:#9BA3AB}
.tg-d{background:rgba(108,255,61,.1);color:#6CFF3D}
.tg-c{background:rgba(255,200,87,.1);color:#FFC857}
.tg-b{background:rgba(255,140,0,.12);color:#FF8C00}
.tg-a{background:rgba(255,59,48,.1);color:#FF3B30}
.tg-s{background:rgba(255,59,48,.2);color:#FF3B30;border:1px solid #FF3B30}
.tg-st{background:rgba(154,154,154,.08);color:#9BA3AB;font-family:'Share Tech Mono',monospace;font-size:10px;padding:2px 7px;border-radius:2px;text-transform:uppercase}

/* TASK CARD */
.tcard{background:#1A1F24;border:1px solid #2A3036;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;gap:10px;transition:background .15s}
.tcard.crit{border-color:rgba(255,200,87,.27)}
.tcard.done{opacity:.45}
.tcard.done .tname{text-decoration:line-through;color:#9BA3AB}
.taccent{width:3px;height:30px;flex-shrink:0;border-radius:2px}
.tbody{flex:1;min-width:0}
.tname{font-weight:600;font-size:14px;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ttags{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.ebtn{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:1px;padding:6px 12px;border:1px solid #2A3036;background:transparent;color:#9BA3AB;cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0;border-radius:0;-webkit-appearance:none}
.ebtn:active:not(:disabled){border-color:#6CFF3D;color:#6CFF3D;background:rgba(108,255,61,.05)}
.ebtn:disabled{opacity:.35;cursor:default}

/* MISSION */
.mcard{background:#1A1F24;border:1px solid #2A3036;padding:12px;margin-bottom:8px}

/* ATTR BAR */
.arow{margin-bottom:10px}
.atop{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-weight:600;font-size:13px;letter-spacing:1px}
.atrack{height:3px;background:#2A3036;border-radius:2px;overflow:hidden}
.afill{height:100%;border-radius:2px;transition:width .6s ease}

/* HIST */
.hbars{display:flex;align-items:flex-end;gap:4px;height:80px}
.hbwrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%;gap:4px}
.hbar{width:100%;border-radius:1px;opacity:.85}
.hday{font-family:'Share Tech Mono',monospace;font-size:8px;color:#9BA3AB}
.lrow{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid #2A3036}
.lrow:last-child{border-bottom:none}
.ldot{width:8px;height:8px;border-radius:1px;flex-shrink:0}
.linfo{margin-left:10px}
.ldate{font-size:13px;font-weight:600}
.lright{text-align:right}

/* FORM */
.flbl{font-family:'Share Tech Mono',monospace;font-size:9px;color:#9BA3AB;letter-spacing:2px;text-transform:uppercase;display:block;margin-bottom:5px}
.finput{background:#0B0F12;border:1px solid #2A3036;color:#E6EDF3;font-family:'Rajdhani',sans-serif;font-size:15px;padding:9px 13px;width:100%;outline:none;transition:border-color .15s;-webkit-appearance:none;border-radius:0}
.finput:focus{border-color:#6CFF3D}
textarea.finput{resize:none}
.pbtn{background:#6CFF3D;color:#0B0F12;border:none;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:14px;letter-spacing:2px;text-transform:uppercase;padding:10px 22px;cursor:pointer;-webkit-appearance:none;border-radius:0;transition:all .15s}
.pbtn:active:not(:disabled){background:#50e822}
.pbtn:disabled{opacity:.4;cursor:not-allowed}
.dbtn{background:transparent;color:#FF3B30;border:1px solid #FF3B30;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:1px;padding:8px 14px;cursor:pointer;-webkit-appearance:none;border-radius:0}
.sbtn{background:transparent;border:1px solid #2A3036;color:#9BA3AB;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:1px;padding:5px 12px;cursor:pointer;border-radius:0;-webkit-appearance:none}
.row{display:flex;gap:8px;align-items:flex-start}
.igrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.icell{background:#2A3036;padding:10px 12px}
.ival{font-family:'Share Tech Mono',monospace;font-size:13px;color:#E6EDF3}

/* PROPOSAL */
.prop{border:1px solid rgba(255,200,87,.25);background:rgba(255,200,87,.04);padding:14px;margin-top:14px;animation:lockin 1.5s ease forwards}
.ptitle{font-weight:700;font-size:18px;letter-spacing:2px;margin-bottom:2px}
.psub{color:#9BA3AB;font-size:13px;margin-bottom:10px}
.ptask{display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:13px}

.divider{height:1px;background:#2A3036;margin:10px 0}

/* TOGGLE */
.toggle{width:38px;height:20px;border-radius:10px;position:relative;transition:background .2s;flex-shrink:0}
.tdot{width:14px;height:14px;background:#E6EDF3;border-radius:7px;position:absolute;top:2px;transition:left .2s}

/* STAT GRID */
.sgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
.sbox{background:#2A3036;padding:8px 10px;text-align:center}

/* TOAST */
#toast{position:fixed;top:76px;left:50%;transform:translateX(-50%);background:#1A1F24;padding:7px 18px;z-index:999;pointer-events:none;white-space:nowrap;display:none;border:1px solid #2A3036}
#tmsg{font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:2px}

.errbox{color:#FF3B30;font-family:'Share Tech Mono',monospace;font-size:11px;margin-top:8px;letter-spacing:1px;display:none}

@keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes lockin{0%{border-color:#6CFF3D;box-shadow:0 0 12px rgba(108,255,61,.4)}100%{border-color:rgba(255,200,87,.25);box-shadow:none}}
@keyframes hplow{0%,100%{opacity:1}50%{opacity:.3}}
.hplow{animation:hplow 1s ease-in-out infinite}
</style>
</head>
<body>
<div id="toast"><span id="tmsg"></span></div>
<div id="app">
  <div id="hud">
    <div class="hud-top">
      <div style="display:flex;align-items:center;flex:1">
        <div class="hud-avatar" id="hlvl">01</div>
        <div class="hud-info">
          <div class="hud-name" id="hname">OPERADOR</div>
          <div class="hud-sub" id="hsub">OPERADOR Â· LVL 1</div>
        </div>
      </div>
      <div class="hud-right">
        <div class="hud-stat">
          <span class="hs-lbl">â—† RACHA</span>
          <span class="hs-val" id="hstreak" style="color:#FFC857">0D</span>
        </div>
        <div class="hud-stat">
          <span class="hs-lbl">XP TOTAL</span>
          <span class="hs-val" id="htxp">0</span>
        </div>
      </div>
    </div>
    <div class="hud-bars">
      <div>
        <div class="bar-row"><span class="blbl">HP</span><span class="blbl" id="hptxt" style="color:#6CFF3D">0/0</span></div>
        <div class="btrack"><div class="bfill" id="hpbar" style="width:0%;background:#6CFF3D"></div></div>
      </div>
      <div>
        <div class="bar-row"><span class="blbl">XP</span><span class="blbl" id="xptxt" style="color:#6CFF3D">0/0</span></div>
        <div class="btrack"><div class="bfill" id="xpbar" style="width:0%;background:#6CFF3D"></div></div>
      </div>
    </div>
  </div>

  <div id="tab-misiones"  class="tab-pane"></div>
  <div id="tab-stats"     class="tab-pane" style="display:none"></div>
  <div id="tab-historial" class="tab-pane" style="display:none"></div>
  <div id="tab-perfil"    class="tab-pane" style="display:none"></div>

  <div id="nav">
    <button class="nav-btn active" onclick="go('misiones')">MISIONES</button>
    <button class="nav-btn"        onclick="go('stats')">STATS</button>
    <button class="nav-btn"        onclick="go('historial')">HISTORIAL</button>
    <button class="nav-btn"        onclick="go('perfil')">PERFIL</button>
  </div>
</div>

<script>
'use strict';
// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var DXP={E:50,D:100,C:180,B:300,A:500,S:800};
var SK=['vitalidad','fuerza','agilidad','resistencia','inteligencia','sabiduria'];
var SL=['VITALIDAD','FUERZA','AGILIDAD','RESISTENCIA','INTELIGENCIA','SABIDURÃA'];
var SI=['â¤ï¸','âš¡','ğŸ’¨','ğŸ›¡ï¸','ğŸ§ ','ğŸ“–'];
var DN=['DOM','LUN','MAR','MIÃ‰','JUE','VIE','SÃB'];
var GREEN='#6CFF3D',AMBER='#FFC857',RED='#FF3B30',MUTED='#9BA3AB';

// â”€â”€â”€ DEFAULT STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var DEF={
  player:{name:'OPERADOR',xp:120,hp:85,maxHp:100,streak:3},
  stats:{vitalidad:14,fuerza:18,agilidad:12,resistencia:16,inteligencia:20,sabiduria:11},
  saga:{name:'PROTOCOLO ALFA',objective:'Establecer rutina de alto rendimiento',
        startDate:new Date(Date.now()-12*864e5).toISOString(),totalDays:90},
  weeklyMissions:[
    {id:'w1',name:'RESISTENCIA FÃSICA',description:'Completa 5 sesiones de entrenamiento esta semana',progress:3,total:5,stat:'fuerza'},
    {id:'w2',name:'CLARIDAD MENTAL',description:'Medita al menos 15 min durante 4 dÃ­as',progress:2,total:4,stat:'sabiduria'}
  ],
  dailyTasks:[
    {id:'t1',name:'Entrenamiento 30 min',difficulty:'C',stat:'fuerza',done:false,critical:true},
    {id:'t2',name:'Leer 20 pÃ¡ginas',difficulty:'D',stat:'inteligencia',done:false,critical:false},
    {id:'t3',name:'MeditaciÃ³n 10 min',difficulty:'D',stat:'sabiduria',done:false,critical:false},
    {id:'t4',name:'Beber 2L de agua',difficulty:'E',stat:'vitalidad',done:false,critical:false},
    {id:'t5',name:'Dormir 7+ horas',difficulty:'C',stat:'resistencia',done:false,critical:true}
  ],
  history:(function(){
    var tasks=[4,5,3,4,5,1,4];
    return tasks.map(function(n,i){
      return{date:new Date(Date.now()-(i+1)*864e5).toISOString(),xpGained:n*70,tasksCompleted:n,totalTasks:5};
    });
  })()
};

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var S, APIKEY='';

function loadS(){
  try{var r=localStorage.getItem('op_v3');if(r)S=JSON.parse(r);}catch(e){}
  if(!S)S=JSON.parse(JSON.stringify(DEF));
  try{APIKEY=localStorage.getItem('op_key')||'';}catch(e){}
}
function saveS(){try{localStorage.setItem('op_v3',JSON.stringify(S));}catch(e){}}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lvl(xp){
  var l=1,th=1000,tot=0;
  while(xp>=tot+th){tot+=th;l++;th=Math.floor(th*1.4);}
  return{level:l,current:xp-tot,needed:th};
}
function hpc(p){return p>60?GREEN:p>30?AMBER:RED;}
function tgc(d){return'tag tg-'+d.toLowerCase();}
function mn(t,sz,col){sz=sz||10;col=col||MUTED;
  return'<span style="font-family:\'Share Tech Mono\',monospace;font-size:'+sz+'px;color:'+col+';letter-spacing:2px;text-transform:uppercase">'+t+'</span>';}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

var toastTimer;
function toast(msg,col,ms){
  col=col||GREEN;ms=ms||2200;
  var t=document.getElementById('toast');
  var m=document.getElementById('tmsg');
  m.textContent=msg;m.style.color=col;
  t.style.borderColor=col+'44';t.style.display='block';
  clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){t.style.display='none';},ms);
}

// â”€â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHUD(){
  var d=lvl(S.player.xp);
  var hp=S.player.hp,maxHp=S.player.maxHp;
  var hpp=Math.min((hp/maxHp)*100,100);
  var xpp=Math.min((d.current/d.needed)*100,100);
  var hc=hpc(hpp);
  document.getElementById('hlvl').textContent=String(d.level).padStart(2,'0');
  document.getElementById('hname').textContent=S.player.name;
  document.getElementById('hsub').textContent='OPERADOR Â· LVL '+d.level;
  document.getElementById('hstreak').textContent=S.player.streak+'D';
  document.getElementById('htxp').textContent=S.player.xp.toLocaleString();
  document.getElementById('hptxt').textContent=hp+'/'+maxHp;
  document.getElementById('hptxt').style.color=hc;
  var hb=document.getElementById('hpbar');
  hb.style.width=hpp+'%';hb.style.background=hc;
  if(hpp<30)hb.classList.add('hplow');else hb.classList.remove('hplow');
  document.getElementById('xptxt').textContent=d.current+'/'+d.needed;
  document.getElementById('xpbar').style.width=xpp+'%';
}

// â”€â”€â”€ TAB SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var CUR='misiones';
function go(tab){
  ['misiones','stats','historial','perfil'].forEach(function(t){
    document.getElementById('tab-'+t).style.display=t===tab?'block':'none';
  });
  document.querySelectorAll('.nav-btn').forEach(function(b,i){
    b.classList.toggle('active',['misiones','stats','historial','perfil'][i]===tab);
  });
  CUR=tab;
  if(tab==='misiones')renderM();
  else if(tab==='stats')renderSt();
  else if(tab==='historial')renderH();
  else renderP();
}

// â”€â”€â”€ MISIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderM(){
  var el=document.getElementById('tab-misiones');
  var elapsed=Math.max(0,Math.floor((Date.now()-new Date(S.saga.startDate).getTime())/864e5));
  var sp=Math.min((elapsed/S.saga.totalDays)*100,100);
  var done=S.dailyTasks.filter(function(t){return t.done;}).length;
  var total=S.dailyTasks.length;

  var h='<div class="panel"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">';
  h+='<div style="flex:1;min-width:0">'+mn('â–  SAGA ACTIVA Â· 90 DÃAS',9,AMBER);
  h+='<div style="font-weight:700;font-size:18px;letter-spacing:2px;margin:3px 0">'+esc(S.saga.name)+'</div>';
  h+='<div style="color:'+MUTED+';font-size:13px">'+esc(S.saga.objective)+'</div></div>';
  h+='<div style="text-align:right;flex-shrink:0;margin-left:12px">';
  h+='<div style="font-family:\'Share Tech Mono\',monospace;font-size:20px;color:'+AMBER+'">'+elapsed+'</div>';
  h+=mn('/ '+S.saga.totalDays+' DÃAS',9)+'</div></div>';
  h+='<div class="btrack" style="height:5px;margin-bottom:6px"><div class="bfill" style="width:'+sp+'%;background:'+AMBER+'"></div></div>';
  h+='<div style="display:flex;justify-content:space-between">'+mn(elapsed+' dÃ­as',9)+mn(S.saga.totalDays-elapsed+' restantes',9)+'</div></div>';

  h+='<span class="slbl">â–  MISIONES SEMANALES</span>';
  S.weeklyMissions.forEach(function(m){
    var p=Math.min((m.progress/m.total)*100,100);
    var col=p>=100?GREEN:AMBER;
    h+='<div class="mcard"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">';
    h+='<span style="font-weight:600;font-size:14px;letter-spacing:1px">'+esc(m.name)+'</span>';
    h+=mn(m.progress+'/'+m.total,11,col)+'</div>';
    h+='<div style="color:'+MUTED+';font-size:12px;margin-bottom:7px">'+esc(m.description)+'</div>';
    h+='<div class="btrack" style="height:3px"><div class="bfill" style="width:'+p+'%;background:'+col+'"></div></div></div>';
  });

  h+='<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0 8px">';
  h+='<span class="slbl" style="margin:0">â–  OBJETIVOS DEL DÃA</span>';
  h+=mn(done+'/'+total,10,done===total?GREEN:MUTED)+'</div>';

  S.dailyTasks.forEach(function(t){
    var ac=t.done?GREEN:t.critical?AMBER:'transparent';
    h+='<div class="tcard'+(t.critical&&!t.done?' crit':'')+(t.done?' done':'')+'">';
    h+='<div class="taccent" style="background:'+ac+'"></div>';
    h+='<div class="tbody"><div class="tname">'+esc(t.name)+'</div>';
    h+='<div class="ttags"><span class="'+tgc(t.difficulty)+'">'+t.difficulty+'</span>';
    h+='<span class="tg-st">'+t.stat+'</span>'+mn('+'+DXP[t.difficulty]+' XP',9)+'</div></div>';
    h+='<button class="ebtn" '+(t.done?'disabled':'')+' onclick="doTask(\''+t.id+'\')">';
    h+=(t.done?'âœ“ DONE':'EXEC')+'</button></div>';
  });

  el.innerHTML=h;
}

function doTask(id){
  var task=null;
  for(var i=0;i<S.dailyTasks.length;i++){if(S.dailyTasks[i].id===id){task=S.dailyTasks[i];break;}}
  if(!task||task.done)return;
  var xpg=DXP[task.difficulty];
  var oldL=lvl(S.player.xp).level;
  S.player.xp+=xpg;
  S.stats[task.stat]=Math.min(S.stats[task.stat]+1,99);
  for(var j=0;j<S.dailyTasks.length;j++){if(S.dailyTasks[j].id===id){S.dailyTasks[j].done=true;break;}}
  var newL=lvl(S.player.xp).level;
  if(newL>oldL)setTimeout(function(){toast('â–² NIVEL '+newL+' ALCANZADO',AMBER);},60);
  else toast('+'+xpg+' XP Â· '+task.stat.toUpperCase()+' +1',GREEN);
  saveS();updateHUD();renderM();
}

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSt(){
  var el=document.getElementById('tab-stats');
  var total=0;var mx=0;
  SK.forEach(function(k){total+=S.stats[k];if(S.stats[k]>mx)mx=S.stats[k];});

  // SVG radar
  var cx=140,cy=130,r=100,n=6;
  var rings='',axes='',poly='',lbs='';
  var abbr=['VIT','FUE','AGI','RES','INT','SAB'];
  for(var ri=1;ri<=4;ri++){
    var pts='';
    for(var i=0;i<n;i++){
      var a=i*(2*Math.PI/n)-Math.PI/2;
      var rr=r*ri/4;
      pts+=(cx+rr*Math.cos(a))+','+(cy+rr*Math.sin(a))+' ';
    }
    rings+='<polygon points="'+pts.trim()+'" fill="none" stroke="#2A3036" stroke-width="1"/>';
  }
  var pp='';
  for(var i=0;i<n;i++){
    var a=i*(2*Math.PI/n)-Math.PI/2;
    axes+='<line x1="'+cx+'" y1="'+cy+'" x2="'+(cx+r*Math.cos(a))+'" y2="'+(cy+r*Math.sin(a))+'" stroke="#2A3036" stroke-width="1"/>';
    var vr=r*(S.stats[SK[i]]/50);
    pp+=(cx+vr*Math.cos(a))+','+(cy+vr*Math.sin(a))+' ';
    var lx=cx+(r+18)*Math.cos(a),ly=cy+(r+18)*Math.sin(a);
    lbs+='<text x="'+lx+'" y="'+ly+'" text-anchor="middle" dominant-baseline="middle" fill="#9BA3AB" font-family="Share Tech Mono,monospace" font-size="10">'+abbr[i]+'</text>';
  }
  poly='<polygon points="'+pp.trim()+'" fill="rgba(108,255,61,0.12)" stroke="#6CFF3D" stroke-width="1.5"/>';
  var svg='<svg viewBox="0 0 280 270" width="100%" style="display:block;max-width:280px;margin:0 auto">'+rings+axes+poly+lbs+'</svg>';

  var bars='';
  SK.forEach(function(k,i){
    var v=S.stats[k],p=Math.min((v/50)*100,100),col=p>60?GREEN:p>30?AMBER:RED;
    bars+='<div class="arow"><div class="atop"><span>'+SI[i]+' '+SL[i]+'</span>';
    bars+='<span style="font-family:\'Share Tech Mono\',monospace;font-size:12px;color:'+col+'">'+v+'</span></div>';
    bars+='<div class="atrack"><div class="afill" style="width:'+p+'%;background:'+col+'"></div></div></div>';
  });

  var dg='';
  Object.keys(DXP).forEach(function(d){
    dg+='<div class="sbox"><span class="'+tgc(d)+'" style="display:block;margin-bottom:4px">'+d+'</span>'+mn('+'+DXP[d]+' XP',11,'#E6EDF3')+'</div>';
  });

  el.innerHTML='<div class="panel"><span class="slbl">â–  PERFIL DE ATRIBUTOS</span>'+svg
    +'<div style="display:flex;justify-content:center;gap:28px;margin-top:8px">'
    +'<div style="text-align:center"><div style="font-family:\'Share Tech Mono\',monospace;font-size:22px;color:'+GREEN+'">'+total+'</div>'+mn('STATS TOTALES',8)+'</div>'
    +'<div style="text-align:center"><div style="font-family:\'Share Tech Mono\',monospace;font-size:22px;color:'+AMBER+'">'+mx+'</div>'+mn('STAT MÃX',8)+'</div>'
    +'</div></div>'
    +'<div class="panel"><span class="slbl">â–  ATRIBUTOS</span>'+bars+'</div>'
    +'<div class="panel"><span class="slbl">â–  ESCALA DE DIFICULTAD</span><div class="sgrid">'+dg+'</div></div>';
}

// â”€â”€â”€ HISTORIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderH(){
  var el=document.getElementById('tab-historial');
  var wXP=0,avgC=0,perf=0;
  S.history.forEach(function(h){
    wXP+=h.xpGained;
    avgC+=(h.tasksCompleted/h.totalTasks)*100;
    if(h.tasksCompleted===h.totalTasks)perf++;
  });
  avgC=Math.round(avgC/S.history.length);

  var bars='';
  S.history.forEach(function(h){
    var p=h.tasksCompleted/h.totalTasks;
    var bh=Math.max(4,p*72);
    var col=p>=1?GREEN:p>=.6?AMBER:RED;
    var d=new Date(h.date);
    bars+='<div class="hbwrap"><div class="hbar" style="height:'+bh+'px;background:'+col+'"></div>';
    bars+='<span class="hday">'+DN[d.getDay()]+'</span></div>';
  });

  var log='';
  var rev=[].concat(S.history).reverse();
  rev.forEach(function(h,i){
    var p=Math.round((h.tasksCompleted/h.totalTasks)*100);
    var col=p>=100?GREEN:p>=60?AMBER:RED;
    var d=new Date(h.date);
    var ds=d.toLocaleDateString('es-MX',{weekday:'short',day:'numeric',month:'short'}).toUpperCase();
    log+='<div class="lrow"><div style="display:flex;align-items:center">';
    log+='<div class="ldot" style="background:'+col+'"></div><div class="linfo">';
    log+='<div class="ldate">'+ds+'</div>'+mn(h.tasksCompleted+'/'+h.totalTasks+' objetivos',9)+'</div></div>';
    log+='<div class="lright"><div style="font-family:\'Share Tech Mono\',monospace;font-size:12px;color:'+GREEN+'">+'+h.xpGained+' XP</div>';
    log+=mn(p+'%',9,col)+'</div></div>';
  });

  el.innerHTML='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">'
    +'<div class="panel" style="padding:12px;text-align:center;margin:0"><div style="font-family:\'Share Tech Mono\',monospace;font-size:18px;color:'+GREEN+'">'+wXP.toLocaleString()+'</div>'+mn('XP SEMANA',8)+'</div>'
    +'<div class="panel" style="padding:12px;text-align:center;margin:0"><div style="font-family:\'Share Tech Mono\',monospace;font-size:18px;color:'+AMBER+'">'+avgC+'%</div>'+mn('PROMEDIO',8)+'</div>'
    +'<div class="panel" style="padding:12px;text-align:center;margin:0"><div style="font-family:\'Share Tech Mono\',monospace;font-size:18px;color:#E6EDF3">'+perf+'</div>'+mn('PERFECTOS',8)+'</div>'
    +'</div>'
    +'<div class="panel"><span class="slbl">â–  ACTIVIDAD 7 DÃAS</span><div class="hbars">'+bars+'</div></div>'
    +'<div class="panel"><span class="slbl">â–  REGISTRO</span>'+log+'</div>';
}

// â”€â”€â”€ PERFIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderP(){
  var el=document.getElementById('tab-perfil');
  var d=lvl(S.player.xp);
  var sd=Math.max(0,Math.floor((Date.now()-new Date(S.saga.startDate).getTime())/864e5));

  el.innerHTML='<div class="panel">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'
    +'<span class="slbl" style="margin:0">â–  FICHA DE OPERADOR</span>'
    +'<button class="sbtn" onclick="toggleNE()">EDITAR</button></div>'
    +'<div id="ne" style="display:none;margin-bottom:12px"><div class="row">'
    +'<input id="ninp" class="finput" maxlength="20" placeholder="NOMBRE TÃCTICO" value="'+esc(S.player.name)+'" style="flex:1;height:38px" oninput="this.value=this.value.toUpperCase()">'
    +'<button class="pbtn" onclick="saveName()" style="height:38px;padding:0 16px">OK</button></div></div>'
    +'<div class="igrid">'
    +'<div class="icell"><div class="flbl">NOMBRE</div><div class="ival">'+esc(S.player.name)+'</div></div>'
    +'<div class="icell"><div class="flbl">NIVEL</div><div class="ival">'+d.level+'</div></div>'
    +'<div class="icell"><div class="flbl">RACHA</div><div class="ival">'+S.player.streak+' dÃ­as</div></div>'
    +'<div class="icell"><div class="flbl">SAGA DÃA</div><div class="ival">'+sd+'/90</div></div>'
    +'<div class="icell"><div class="flbl">HP</div><div class="ival">'+S.player.hp+'/'+S.player.maxHp+'</div></div>'
    +'<div class="icell"><div class="flbl">XP TOTAL</div><div class="ival">'+S.player.xp.toLocaleString()+'</div></div>'
    +'</div></div>'

    +'<div class="panel"><span class="slbl">â–  API KEY DE ANTHROPIC</span>'
    +'<div style="color:'+MUTED+';font-size:12px;margin-bottom:10px">Necesaria para el generador IA. ObtÃ©n la tuya en <span style="color:'+GREEN+'">console.anthropic.com</span></div>'
    +'<div class="row" style="margin-bottom:8px">'
    +'<input id="kinp" class="finput" type="password" placeholder="sk-ant-..." value="'+esc(APIKEY)+'" style="flex:1;height:38px">'
    +'<button class="sbtn" onclick="toggleKV()" style="height:38px">VER</button></div>'
    +'<div style="display:flex;justify-content:flex-end"><button class="pbtn" onclick="saveKey()">GUARDAR KEY</button></div>'
    +(APIKEY?'<div style="margin-top:8px">'+mn('âœ“ API KEY GUARDADA',10,GREEN)+'</div>':'')+'</div>'

    +'<div class="panel"><span class="slbl">â–  GENERADOR DE MISIONES IA</span>'
    +'<div style="color:'+MUTED+';font-size:12px;margin-bottom:12px">Describe tu objetivo real. La IA genera una misiÃ³n tÃ¡ctica estructurada.</div>'
    +'<textarea id="aiinp" class="finput" rows="3" placeholder="Ej: Quiero perder 10kg en 3 meses haciendo ejercicio y controlando mi alimentaciÃ³n..."></textarea>'
    +'<div style="display:flex;justify-content:flex-end;margin-top:8px">'
    +'<button id="aibtn" class="pbtn" onclick="genMission()">âš¡ GENERAR MISIÃ“N</button></div>'
    +'<div id="aierr" class="errbox"></div>'
    +'<div id="aiprop"></div></div>'

    +'<div class="panel" style="border-color:'+(S.player.hp<40?AMBER+'44':'#2A3036')+'">'
    +'<span class="slbl">â–  MODO OPERADOR SOBRECARGADO</span>'
    +'<div style="color:'+MUTED+';font-size:12px;margin-bottom:10px">Se activa si tu HP cae bajo 40. Reduce carga automÃ¡ticamente.</div>'
    +'<div style="display:flex;align-items:center;gap:10px">'
    +'<div class="toggle" style="background:'+(S.player.hp<40?AMBER:'#2A3036')+';border:1px solid '+(S.player.hp<40?AMBER:'#2A3036')+'">'
    +'<div class="tdot" style="left:'+(S.player.hp<40?'20':'2')+'px"></div></div>'
    +mn(S.player.hp<40?'ACTIVO â€” HP CRÃTICO':'INACTIVO',10,S.player.hp<40?AMBER:MUTED)+'</div></div>'

    +'<div class="panel"><span class="slbl">â–  DATOS</span>'
    +'<button class="dbtn" onclick="resetAll()">RESETEAR PROGRESO</button></div>';
}

function toggleNE(){var d=document.getElementById('ne');d.style.display=d.style.display==='none'?'block':'none';}
function saveName(){
  var v=document.getElementById('ninp').value.trim();
  if(!v)return;
  S.player.name=v;saveS();updateHUD();renderP();toast('âœ“ NOMBRE ACTUALIZADO',GREEN);
}
function toggleKV(){var i=document.getElementById('kinp');i.type=i.type==='password'?'text':'password';}
function saveKey(){
  var v=document.getElementById('kinp').value.trim();
  APIKEY=v;try{localStorage.setItem('op_key',v);}catch(e){}
  renderP();toast('âœ“ API KEY GUARDADA',GREEN);
}
function resetAll(){
  if(!confirm('Â¿Resetear todo el progreso?'))return;
  try{localStorage.removeItem('op_v3');}catch(e){}
  S=JSON.parse(JSON.stringify(DEF));saveS();updateHUD();renderP();toast('DATOS RESETEADOS',AMBER);
}

// â”€â”€â”€ AI GENERATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genMission(){
  var inp=document.getElementById('aiinp');
  var btn=document.getElementById('aibtn');
  var err=document.getElementById('aierr');
  var prop=document.getElementById('aiprop');
  if(!inp||!inp.value.trim())return;
  if(!APIKEY){err.textContent='âš  Ingresa tu API Key de Anthropic primero.';err.style.display='block';return;}
  btn.disabled=true;btn.textContent='âš¡ PROCESANDO...';
  err.style.display='none';prop.innerHTML='';

  var body=JSON.stringify({
    model:'claude-sonnet-4-20250514',
    max_tokens:1000,
    system:'Eres un generador de misiones RPG tÃ¡cticas para un sistema de hÃ¡bitos estilo military.\nResponde SOLO con JSON puro sin markdown:\n{"sagaName":"NOMBRE MAYÃšSCULAS 3 palabras","objective":"objetivo en una lÃ­nea","weeklyMissions":[{"name":"NOMBRE","description":"descripciÃ³n","total":4,"stat":"fuerza"},{"name":"NOMBRE","description":"descripciÃ³n","total":5,"stat":"inteligencia"}],"dailyTasks":[{"name":"acciÃ³n","difficulty":"D","stat":"fuerza","critical":false},{"name":"acciÃ³n","difficulty":"C","stat":"resistencia","critical":true},{"name":"acciÃ³n","difficulty":"E","stat":"vitalidad","critical":false},{"name":"acciÃ³n","difficulty":"D","stat":"inteligencia","critical":false}]}\nStats: vitalidad,fuerza,agilidad,resistencia,inteligencia,sabiduria. Dificultades: E,D,C,B,A,S.',
    messages:[{role:'user',content:'Mi objetivo: '+inp.value}]
  });

  fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key':APIKEY,
      'anthropic-version':'2023-06-01',
      'anthropic-dangerous-direct-browser-access':'true'
    },
    body:body
  }).then(function(r){return r.json();}).then(function(data){
    if(data.error)throw new Error(data.error.message);
    var text=data.content&&data.content[0]&&data.content[0].text||'';
    var clean=text.replace(/```json|```/g,'').trim();
    var p=JSON.parse(clean);
    showProp(p,prop);
  }).catch(function(e){
    err.textContent='âš  '+e.message;err.style.display='block';
  }).finally(function(){
    btn.disabled=false;btn.textContent='âš¡ GENERAR MISIÃ“N';
  });
}

function showProp(p,el){
  var th='';
  (p.dailyTasks||[]).forEach(function(t){
    th+='<div class="ptask"><span class="'+tgc(t.difficulty)+'">'+t.difficulty+'</span><span>'+esc(t.name)+'</span>'+(t.critical?'<span style="color:'+AMBER+';font-size:10px">â˜…</span>':'')+'</div>';
  });
  var mh='';
  (p.weeklyMissions||[]).forEach(function(m){
    mh+='<div style="background:#2A3036;padding:7px 10px;margin-bottom:5px;font-size:13px"><b>'+esc(m.name)+'</b> <span style="color:'+MUTED+';margin-left:6px">'+esc(m.description)+'</span></div>';
  });
  var js=esc(JSON.stringify(p));
  el.innerHTML='<div class="divider"></div><div class="prop">'
    +mn('âš¡ PROPUESTA DE MISIÃ“N',9,AMBER)
    +'<div class="ptitle" style="margin-top:8px">'+esc(p.sagaName||'NUEVA SAGA')+'</div>'
    +'<div class="psub">'+esc(p.objective||'')+'</div>'
    +mn('MISIONES SEMANALES',9)+'<div style="margin:6px 0 10px">'+mh+'</div>'
    +mn('TAREAS DIARIAS',9)+'<div style="margin:6px 0 14px">'+th+'</div>'
    +'<div class="row">'
    +'<button class="pbtn" onclick=\'acceptM('+JSON.stringify(JSON.stringify(p))+')\'> âœ“ ACEPTAR</button>'
    +'<button class="dbtn" onclick="document.getElementById(\'aiprop\').innerHTML=\'\'">DESCARTAR</button>'
    +'</div></div>';
}

function acceptM(js){
  var p=JSON.parse(js);
  var nt=(p.dailyTasks||[]).map(function(t,i){
    return{id:'ai_t'+Date.now()+'_'+i,name:t.name,difficulty:t.difficulty||'C',stat:t.stat||'fuerza',done:false,critical:!!t.critical};
  });
  var nm=(p.weeklyMissions||[]).map(function(m,i){
    return{id:'ai_m'+Date.now()+'_'+i,name:m.name,description:m.description,progress:0,total:m.total||5,stat:m.stat||'fuerza'};
  });
  S.saga=Object.assign({},S.saga,{name:p.sagaName||S.saga.name,objective:p.objective||S.saga.objective,startDate:new Date().toISOString()});
  S.weeklyMissions=nm;S.dailyTasks=nt;
  saveS();toast('â–² NUEVA MISIÃ“N ACTIVADA',AMBER);go('misiones');
}

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadS();
updateHUD();
renderM();
</script>
</body>
</html>
